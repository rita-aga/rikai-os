name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.12"

jobs:
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          uv pip install --system -e ".[dev]"

      - name: Lint with ruff
        run: ruff check .

      - name: Type check with mypy
        run: mypy src/rikai --ignore-missing-imports

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: rikai
          POSTGRES_PASSWORD: rikai_test_password
          POSTGRES_DB: rikai_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      minio:
        image: minio/minio:latest
        ports:
          - 9000:9000
        env:
          MINIO_ROOT_USER: rikai
          MINIO_ROOT_PASSWORD: rikai_test_password
        options: >-
          --health-cmd "curl -f http://localhost:9000/minio/health/live"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        # Override entrypoint to start server
        # entrypoint: minio server /data

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          uv pip install --system -e ".[dev]"

      - name: Wait for MinIO
        run: |
          until curl -f http://localhost:9000/minio/health/live 2>/dev/null; do
            echo "Waiting for MinIO..."
            sleep 2
          done

      - name: Create MinIO bucket
        run: |
          pip install minio
          python -c "
          from minio import Minio
          client = Minio('localhost:9000', 'rikai', 'rikai_test_password', secure=False)
          if not client.bucket_exists('rikai-documents'):
              client.make_bucket('rikai-documents')
          "

      - name: Run tests
        env:
          RIKAI_POSTGRES_URL: postgresql://rikai:rikai_test_password@localhost:5432/rikai_test
          RIKAI_VECTOR_BACKEND: pgvector
          RIKAI_MINIO_ENDPOINT: localhost:9000
          RIKAI_MINIO_ACCESS_KEY: rikai
          RIKAI_MINIO_SECRET_KEY: rikai_test_password
          RIKAI_MINIO_BUCKET: rikai-documents
          RIKAI_MINIO_SECURE: "false"
        run: pytest -v --tb=short

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: rikaios:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
